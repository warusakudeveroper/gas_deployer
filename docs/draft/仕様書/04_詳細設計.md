---
title: 04_詳細設計（Module / API / Sequence / Validation）
status: draft-2
last_updated: 2025-09-05
---

# 1. モジュール詳細（管理プロキシ）

- 定数
  - `API_BASE = 'https://script.googleapis.com/v1'`

- `getBearer_(): string`
  - 役割: `ScriptApp.getOAuthToken()` を取得し `Bearer ${token}` を返す。
  - 例外: なし（Apps Script 仕様に準拠）。

- `fetchJson_(url: string, opt: {method?:'get'|'post'|'put'|'patch'|'delete', body?:any, headers?:object}): any`
  - 入力: HTTP メソッド・ボディ・追加ヘッダ。
  - 出力: JSON パース済みオブジェクト。
  - 例外: HTTP ステータスが 2xx 以外の場合 `Error('HTTP ${code}: ${raw}')` を throw。
  - 実装: `UrlFetchApp.fetch` を使用。`Authorization: getBearer_()` を必ず付与。

- `api`（Apps Script API v1 ラッパ）
  - `getContent(scriptId: string)` → `GET /projects/{id}/content`
  - `updateContent(scriptId: string, files: Files)` → `PUT /projects/{id}/content`（`{files}`）
  - `createVersion(scriptId: string, description?: string)` → `POST /projects/{id}/versions`
  - `createDeployment(scriptId: string, versionNumber: number, description?: string)` → `POST /projects/{id}/deployments`
  - `listDeployments(scriptId: string)` → `GET /projects/{id}/deployments`
  - `updateDeployment(scriptId: string, deploymentId: string, versionNumber: number, description?: string)` → `PATCH /projects/{id}/deployments/{depl}`（`{deploymentConfig:{manifestFileName:'appsscript',versionNumber,description}}`）
  - `undeploy(scriptId: string, deploymentId: string)` → `DELETE /projects/{id}/deployments/{depl}`
  - `run(scriptId: string, functionName: string, parameters?: any[], devMode?: boolean)` → `POST /scripts/{id}:run`（`{function,parameters,devMode}`）
  - `listVersions(scriptId: string)` → `GET /projects/{id}/versions`

- `normalizeRunResult_(raw: any): {ok, result, logs, error, meta}`
  - 成功系: `{ ok:true, result: raw.response.result??null, logs: raw.log||[], error:null, meta:{executionId: raw.executionId||null} }`
  - 失敗系: `raw.error.details[0]` を `message/type/stack[{func,line}]` にマッピング。

- `required_(obj:any, key:string)`
  - 役割: 未指定（undefined/null）なら `Error('Missing required param: ${key}')` を投げる。

- `handle_(method:string, params:object)`
  - スイッチにより各メソッドへ委譲。
  - AdminShim 必須メソッドは `run` 呼出で shim 関数を叩き、`normalizeRunResult_` を通して返却。
  - 追加分: `listVersions` は `api.listVersions` を呼び、`ensureAdminShim` は下記の通り実装。

- `doPost(e)` / `doGet()`
  - `doPost`: `e.postData.contents` を JSON パース、`handle_` 呼出、`jsonOut_` で返却。B 案時は `X-Admin-Token` と allowlist を検証（実装点参照）。
  - `doGet`: `{ok:true,data:{ping:true}}` を返却。

- `jsonOut_(obj:any, code:number)`
  - `ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(JSON)`。
  - 備考: WebApp のヘッダ制御は限定的。CORS を厳密に扱う用途ではサーバ中継を推奨。

# 2. AdminShim 詳細

- `admin_listTriggers()`
  - 出力: `ScriptApp.getProjectTriggers()` を `{id?, handlerFunction, type}` に整形。
- `admin_createTimeTrigger(handlerFunction:string, everyMinutes:number)`
  - 既定: 1 時間。1–60 の範囲で分間隔を受け付け。
- `admin_deleteTriggerByFunction(handlerFunction:string)`
  - 同名ハンドラのトリガーを全削除。戻り値 `{deleted:number}`。
- `admin_listProperties(store)` / `admin_setProperties(store,obj)` / `admin_deleteProperty(store,key)`
  - `store in {'script','user','document'}`。内部 `pickStore_` で切替。

# 3. シーケンス（代表）

- 更新→実行→公開（推奨フロー）
  1) getContent で現状をバックアップ
  2) updateContent で差分反映（全置換）
  3) run(devMode:true) でユニット関数を実行
  4) ok=false なら error.stack[0] を解析し修正→再試行（最大 2 回）
  5) createVersion → listDeployments → updateDeployment で公開差し替え

- トリガー作成
  1) AdminShim の存在を getContent 結果で確認（無ければ注入）
  2) run('admin_createTimeTrigger',[handler,every]) を devMode:true で実行

# 4. バリデーション/ガード（B 案詳細）

- サーバ側（doPost 先頭）にて：
  - `const TOKEN = '<任意の強秘密値>'; const ALLOW = ['<scriptId1>','<scriptId2>',...]` を定義（仕様上の固定キー名）。
  - `e.parameter` と `e.requestHeaders['X-Admin-Token']` を検査し、トークン不一致は 403 を返す。
  - `params.scriptId` が `ALLOW` に含まれない場合も 403。

# 5. データ完全性/整合性

- updateContent 前にクライアントは getContent を保存し、失敗時は直前状態へ復旧できること。
- files 配列は `appsscript`（JSON）を含めることが望ましい（マニフェストの明示制御）。

# 6. テスト観点（抜粋）

- 正常系: 主要メソッドが 200/ok:true を返すこと。
- 権限系: ユーザー権限 A 案で、非共有の scriptId に対し 403 または同等のエラーとなること。
- 破壊系: updateContent で未指定ファイルが消えること（仕様どおり）。
- run 例外: エラー時に error.stack[] が含まれること。
- 追加: listVersions が versions[] を返すこと。ensureAdminShim の初回で injected:true、それ以降は injected:false。

# 7. 実装指針（抜粋コード）

- listVersions（ラッパ）

```
api.listVersions = function listVersions(scriptId) {
  const url = `${API_BASE}/projects/${encodeURIComponent(scriptId)}/versions`;
  return fetchJson_(url, { method: 'get' });
};
```

- ensureAdminShim（安全導入）概略

```
function ensureAdminShim_(scriptId) {
  // 1) 現状取得
  const cur = api.getContent(scriptId);
  const has = (cur.files || []).some(f => f.name === 'AdminShim' && f.type === 'SERVER_JS');
  if (has) return { injected: false };
  // 2) 追記内容
  const shim = { name: 'AdminShim', type: 'SERVER_JS', source: DEFAULT_ADMIN_SHIM_SOURCE };
  // 3) マージ（全置換仕様のため、既存 + 追加で PUT）
  const files = (cur.files || []).concat([shim]);
  api.updateContent(scriptId, files);
  return { injected: true };
}
```

- ルーター追加

```
case 'listVersions':
  return api.listVersions(required_(params, 'scriptId'));
case 'ensureAdminShim':
  return ensureAdminShim_(required_(params, 'scriptId'));
```

- B 案ガード（サンプル）

```
const CONFIG = { TOKEN: 'change-me', ALLOW: ['<scriptId>'] };
function checkGuard_(headers, scriptId) {
  if (!headers || headers['X-Admin-Token'] !== CONFIG.TOKEN) {
    throw new Error('ERR_NOT_ALLOWED: bad token');
  }
  if (CONFIG.ALLOW.indexOf(scriptId) < 0) {
    throw new Error('ERR_NOT_ALLOWED: not in allowlist');
  }
}
```

- doPost 内でのガード呼出（例）

```
const body = JSON.parse(e.postData.contents || '{}');
const scriptId = body && body.params && body.params.scriptId;
checkGuard_(e && e.parameter, scriptId); // Apps Script のヘッダ取得制約に応じ、必要に応じて変更
```

