---
title: 02_詳細要件（Functional / Non-Functional Requirements）
status: draft-2
last_updated: 2025-09-05
---

# 1. 機能要件（Functional Requirements）

- FR-001: 対象GASのソース取得
  - 入力: scriptId
  - 出力: Apps Script API v1 projects.getContent 互換
  - 受入基準: 指定 scriptId に対して 200 系で取得できる（権限がある場合）。

- FR-002: 対象GASのソース全置換更新
  - 入力: scriptId, files[]（name,type,source）
  - 挙動: 既存ファイル群を全置換。存在しないファイルは新規作成、未指定ファイルは削除。
  - 受入基準: 更新後の getContent で files が完全一致。

- FR-003: バージョン作成
  - 入力: scriptId, description?
  - 出力: versionNumber を含む API 応答。

- FR-004: デプロイ作成
  - 入力: scriptId, versionNumber, description?
  - 出力: 新規デプロイ情報。

- FR-005: デプロイ一覧
  - 入力: scriptId
  - 出力: deployments[]

- FR-006: 既存デプロイの差し替え
  - 入力: scriptId, deploymentId, versionNumber, description?
  - 挙動: 指定デプロイのバージョンを差し替え（PATCH）。

- FR-007: デプロイ取り下げ
  - 入力: scriptId, deploymentId

- FR-008: 関数実行（最新版 or バージョン）
  - 入力: scriptId, functionName, parameters[], devMode?
  - 出力: 正規化済みレスポンス（ok,data,error,logs,meta.executionId）。

- FR-009: トリガー操作（AdminShim 必須）
  - listTriggers, createTimeTrigger, deleteTriggerByFunction。

- FR-010: プロパティ操作（AdminShim 必須）
  - listProperties, setProperties, deleteProperty。

- FR-011: HTML テンプレート取込
  - 入力: updateContent の files に type:HTML を含める。

- FR-012: 統一レスポンス
  - すべてのメソッドで `{ok,data,error,logs,meta}` を返す。

- FR-013: バージョン一覧取得
  - 入力: scriptId
  - 出力: Apps Script API v1 `projects.versions.list` 互換（`versions[]`）。

- FR-014: AdminShim の存在確認と自動注入
  - メソッド: `ensureAdminShim`
  - 入力: scriptId
  - 挙動: `getContent` で AdminShim の有無を確認し、未導入なら既定テンプレを `updateContent` へ安全にマージして導入。
  - 出力: `{ ok:true, data:{ injected:boolean } }`

- FR-015: CLI 互換（コマンド最小集合）
  - `get / update / run / version / deploy / depl:list / depl:update / versions:list / trig:list / trig:add / trig:del / prop:list / prop:set / prop:del`
  - 単一エンドポイント（POST）で完結すること。

# 2. 非機能要件（NFR）

- NFR-001: セキュリティ（実行者）
  - A案: 「アクセスしているユーザーとして実行」。対象はユーザー権限に限定。
  - B案: 「自分として実行」。X-Admin-Token と scriptId Allowlist を実装し、未許可は 403。

- NFR-002: 認証・認可
  - Apps Script API v1 を呼ぶための OAuth トークンは ScriptApp.getOAuthToken を用い、Bearer で送出。
  - doPost は Content-Type: application/json のみ受理。B案では X-Admin-Token を検証。

- NFR-003: 可用性/レート制限
  - 429/5xx に対し指数バックオフ（1s, 2s, 4s）で最大 3 回再試行する方針をクライアントで採用。

- NFR-004: ログ/監査
  - run 応答の executionId をレスポンス meta に必ず含める。

- NFR-005: 保守性
  - メソッド拡張は method enum に追加。後方互換を壊す変更は仕様のバージョン更新が必要。

- NFR-006: 信頼性（破壊的更新の防止）
  - updateContent 実行前に getContent バックアップを必須化（クライアント規約）。

- NFR-007: 導入の簡易さ
  - Web アプリは単一ファイル（Code.gs）＋スコープ設定で稼働可能。
  - 既定運用は B 案（代行運用）とし、`X-Admin-Token` と Allowlist だけで CLI から即利用できる。

# 3. 入出力仕様（I/O Contracts）

# 3. 入出力仕様（I/O Contracts）

- 共通リクエスト
  - JSON: { method: string, params: object }
  - method は以下のいずれか: [ping, getContent, updateContent, createVersion, createDeployment, listDeployments, updateDeployment, undeploy, run, listTriggers, createTimeTrigger, deleteTriggerByFunction, listProperties, setProperties, deleteProperty]
  - 追加: [listVersions, ensureAdminShim]

- 共通レスポンス
  - JSON: { ok: boolean, data: any|null, error: object|null, logs: string[]|undefined, meta: object|undefined }

# 4. バリデーション要件（Validation）

- scriptId は非空文字列。32 文字以上を想定（Apps Script ID 形式）。
- files[].name は非空、ASCII/日本語可。type は Apps Script API の列挙に準拠（SERVER_JS/HTML/JSON/TS 等）。
- run.parameters は JSON シリアライズ可能であること。
- AdminShim 依存メソッド実行時、対象に AdminShim が存在しない場合は `ok:false` として明示のエラーコードを返す（ERR_ADMIN_SHIM_MISSING）。
- ensureAdminShim 実行時、既存 `files` と競合しないこと（重名ファイルはコンテンツ一致を確認し、差異があれば ERR_ADMIN_SHIM_CONFLICT）。

# 5. エラーモデル（Error Model）

- HTTP エラーを含むすべての失敗系は `{ok:false,error:{message,type,stack?},...}` に正規化。
- scripts.run 失敗時は error.stack[] に {func,line} の配列を格納。
 - エラーコード（例）: `ERR_ADMIN_SHIM_MISSING`, `ERR_ADMIN_SHIM_CONFLICT`, `ERR_NOT_ALLOWED`（Allowlist 違反）, `ERR_BAD_PARAMS`。
