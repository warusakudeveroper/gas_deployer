---
title: 03_基本設計（Architecture / Components / Interfaces）
status: draft-2
last_updated: 2025-09-05
---

# 1. アーキテクチャ（全体像）

- 構成: クライアント（AI/CLI） → 管理プロキシ（GAS Web アプリ） → Apps Script API v1
- 役割:
  - 管理プロキシ: 認証（ユーザー権限/OAuth トークン取得）、API 呼出、レスポンス正規化。
  - AdminShim: トリガー/プロパティなど GAS ランタイム内機能の外部委譲先。

# 2. コンポーネント設計

- Web アプリ（管理プロキシ）
  - `getBearer_()`: `ScriptApp.getOAuthToken()` を返す。
  - `fetchJson_(url, opt)`: 共通 HTTP 呼出（UrlFetchApp）。JSON 解析と 2xx 判定、エラー時 throw。
  - `api`: Apps Script API v1 の主要メソッド群（getContent, updateContent, createVersion, createDeployment, listDeployments, updateDeployment, undeploy, run）。
  - 追加メソッド: `listVersions`（GET /projects/{id}/versions）
  - 補助メソッド: `ensureAdminShim`（AdminShim を安全導入）
  - `normalizeRunResult_(raw)`: scripts.run レスポンスを `{ok,data,error,logs,meta}` に正規化。
  - `handle_(method, params)`: ルーター。必須パラメータ検査と api 呼出。
  - `doPost(e)`: 入口。JSON 解析 → handle_ → 統一レスポンスで返却。
  - `doGet()`: 動作確認用 ping。

- AdminShim（対象GAS）
  - `admin_listTriggers()` / `admin_createTimeTrigger()` / `admin_deleteTriggerByFunction()`。
  - `admin_listProperties()` / `admin_setProperties()` / `admin_deleteProperty()`。
  - `pickStore_(store)`: `script|user|document` の選択。

# 3. 外部インターフェース（API）

- HTTP: `POST …/exec`、`Content-Type: application/json`、ボディに {method,params}。
- セキュリティ
  - A案: Web アプリ＝アクセスしているユーザーとして実行。
  - B案: X-Admin-Token を検証、scriptId を allowlist で制御（CLI 利用容易性のため既定推奨）。

# 3.1 CLI 互換コマンド設計（規範）

- 規範コマンド集合（gas-admin 互換）: `get / update / run / version / deploy / depl:list / depl:update / versions:list / trig:list / trig:add / trig:del / prop:list / prop:set / prop:del / whoami`
- マッピング例:
  - `get` → `getContent`
  - `update` → `updateContent`
  - `run` → `run`
  - `version` → `createVersion`
  - `deploy` → `createDeployment`
  - `depl:list` → `listDeployments`
  - `depl:update` → `updateDeployment`
  - `versions:list` → `listVersions`
  - `trig:*`, `prop:*` → AdminShim 経由メソッド

# 4. データ構造（主要）

- Files[] 要素: {name:string, type:string, source:string}
- 統一レスポンス: {ok:boolean, data:any|null, error:{message,type,stack?}|null, logs?:string[], meta?:{executionId?:string}}

# 5. 例外/エラー設計

- fetchJson_ が HTTP 4xx/5xx を throw。doPost で `{ok:false,...}` に包んで返却（code=400 推奨）。
- scripts.run の `error.details[0]` を展開し、stack を配列化。
 - Allowlist 違反は 403 とし、`{ok:false,error:{type:'ERR_NOT_ALLOWED'}}` を返す。

# 6. 運用モード定義

- A案（ユーザーセッション）:
  - デプロイ設定: 実行者=アクセスしているユーザー、アクセス=Google アカウントを持つ全員。
  - 特性: ユーザーごとの権限境界を自動で維持。

- B案（代行運用）:
  - デプロイ設定: 実行者=自分、アクセス=全員（リンク）等。
  - 必須: X-Admin-Token, scriptId Allowlist による防御（仕様で必須）。未許可は 403。
