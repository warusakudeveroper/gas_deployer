
**GAS 管理プロキシ（Web アプリ）＋ AdminShim（対象GAS側）**の構成で、ゼロから動くまでを最短手順でまとめます。  
（_前回出したサンプルコードを“そのまま”使える手順です。必要な差分もここに含めました_）

---

# 0) 事前チェック（1回だけ）

1. **Apps Script API を有効化**  
    [https://script.google.com/home/usersettings](https://script.google.com/home/usersettings) → **「Google Apps Script API」ON**。
    
2. **Google アカウントにログイン**（Web アプリは基本ログインセッションで認証されます）
    
3. 運用モードを決める
    
    - **A: ユーザー権限で操作（推奨）**  
        _「実行するユーザー：アクセスしているユーザー」「アクセスできるユーザー：Google アカウントを持つ全員」_  
        → ログイン済ユーザーの権限でのみ対象GASを操作。  
        ※ CLI から直接叩く場合は認証クッキーが必要（ブラウザ or ローカルHTTPクライアントでセッション共有）。
        
    - **B: オーナー権限で操作（代行運用）**  
        _「実行者：自分」「アクセス：全員（リンク）等」_＋**scriptId Allowlist**やAPIキーでガード。  
        → 1人（あなた）に権限を集中。CLI から叩きやすいが、権限管理はあなた側で担保。
        

---

# 1) 管理プロキシ（GAS Web アプリ）を作る

1. Apps Script で**新規プロジェクト**を作成（任意名：`GAS Admin Proxy`）。
    
2. `appsscript.json` を以下で上書き（**スコープ重要**）：
    

```json
{
  "timeZone": "Asia/Tokyo",
  "exceptionLogging": "STACKDRIVER",
  "oauthScopes": [
    "https://www.googleapis.com/auth/script.projects",
    "https://www.googleapis.com/auth/script.deployments",
    "https://www.googleapis.com/auth/script.scriptapp",
    "https://www.googleapis.com/auth/script.external_request",
    "https://www.googleapis.com/auth/drive.readonly"
  ]
}
```

3. `Code.gs` に**管理プロキシ本体**を貼り付け（前回の「最小実装（GAS：Code.gs）」＋`run`/`normalizeRunResult_`＋ルーター追記を**丸ごと**コピペ）。
    
    - 含まれていること：`getContent / updateContent / createVersion / createDeployment / listDeployments / updateDeployment / undeploy / run` と正規化レスポンス、`doPost/doGet`。
        
4. **デプロイ** → **ウェブアプリ**
    
    - _A案（ユーザー権限運用・推奨）_:
        
        - 実行するユーザー：**アクセスしているユーザー**
            
        - アクセスできるユーザー：**Google アカウントを持つ全員**（匿名不可）
            
    - _B案（管理者代行運用）_:
        
        - 実行者：**自分**
            
        - アクセス：**全員（リンク）** など
            
        - 併せて `scriptId` の **Allowlist** や **共有シークレット**（例：`X-Admin-Token`）チェックを `doPost` に入れると安全。
            
5. 初回アクセスで**権限承認**（表示される権限をすべて許可）。
    

> ✅ これで Web エンドポイント（`…/exec`）が出ました。以降、このURLに JSON を POST すれば管理操作ができます。

---

# 2) 対象GASに AdminShim を入れる（1回だけ）

トリガー／プロパティ操作は REST 直叩きが無いので**対象GAS側にシム**を置き、`scripts.run` で呼びます。

1. 管理したい**対象GAS**を開く（既存でも新規でもOK）。
    
2. 新規ファイル `AdminShim.gs` を作成し、前回提示の **AdminShim コード**を貼り付け。
    
    - 提供関数：`admin_listTriggers / admin_createTimeTrigger / admin_deleteTriggerByFunction / admin_listProperties / admin_setProperties / admin_deleteProperty`。
        
3. 初回実行時に**権限承認**が必要な場合は許可。
    

> 🧩 AdminShim が入っていないプロジェクトは、管理プロキシの `updateContent` で後から**自動注入**してもOK（AIにやらせる運用）。

---

# 3) 動作テスト（最低限の通し）

以降、すべて **管理プロキシURL（`…/exec`）** に `Content-Type: application/json` で POST。

### a. ping（疎通）

```json
{ "method": "ping", "params": {} }
```

→ `{"ok":true,"data":{"pong":true,"user":null}}` などが返れば疎通OK。

### b. 対象GASのソース取得

```json
{
  "method": "getContent",
  "params": { "scriptId": "YOUR_SCRIPT_ID" }
}
```

### c. HTMLテンプレを含めて更新（全置換）

```json
{
  "method": "updateContent",
  "params": {
    "scriptId": "YOUR_SCRIPT_ID",
    "files": [
      {"name":"Index","type":"HTML","source":"<!doctype html><html><body><?= name ?></body></html>"},
      {"name":"Code","type":"SERVER_JS","source":"function doGet(){ const t=HtmlService.createTemplateFromFile('Index'); t.name='Lacis'; return t.evaluate().setTitle('Demo'); }"},
      {"name":"appsscript","type":"JSON","source":"{ \"timeZone\":\"Asia/Tokyo\" }"}
    ]
  }
}
```

### d. 関数実行（ログ・スタック取得）

```json
{
  "method": "run",
  "params": {
    "scriptId": "YOUR_SCRIPT_ID",
    "functionName": "doGet",
    "parameters": [],
    "devMode": true
  }
}
```

→ `ok` / `logs` / `error.stack` / `meta.executionId` が返ります。

### e. バージョン作成 → デプロイ

1. `createVersion` → `versionNumber` を控える
    
2. `createDeployment`（または `listDeployments`→`updateDeployment` で差し替え）
    

---

# 4) トリガー＆プロパティ（AdminShim 経由）

### トリガー一覧

```json
{"method":"listTriggers","params":{"scriptId":"YOUR_SCRIPT_ID"}}
```

### 5分おきトリガー作成

```json
{
  "method":"createTimeTrigger",
  "params":{"scriptId":"YOUR_SCRIPT_ID","handlerFunction":"tick","everyMinutes":5}
}
```

### ハンドラー名で一括削除

```json
{
  "method":"deleteTriggerByFunction",
  "params":{"scriptId":"YOUR_SCRIPT_ID","handlerFunction":"tick"}
}
```

### スクリプト・ユーザー・ドキュメントプロパティ

- 一覧
    

```json
{"method":"listProperties","params":{"scriptId":"YOUR_SCRIPT_ID","store":"script"}}
```

- 一括設定
    

```json
{"method":"setProperties","params":{"scriptId":"YOUR_SCRIPT_ID","store":"script","props":{"API_KEY":"xxx","ENV":"prod"}}}
```

- 1件削除
    

```json
{"method":"deleteProperty","params":{"scriptId":"YOUR_SCRIPT_ID","store":"script","key":"API_KEY"}}
```

---

# 5) ClaudeCode / MCP ツール登録（最低スキーマ）

```json
{
  "name": "gas_admin",
  "description": "Manage GAS: get/update content, run with logs, versions/deployments, triggers & properties.",
  "endpoint": "POST https://script.google.com/macros/s/AKfy.../exec",
  "schema": {
    "type": "object",
    "properties": {
      "method": {
        "type":"string",
        "enum":["ping","getContent","updateContent","createVersion","createDeployment","listDeployments","updateDeployment","undeploy","run","listTriggers","createTimeTrigger","deleteTriggerByFunction","listProperties","setProperties","deleteProperty"]
      },
      "params":{"type":"object"}
    },
    "required":["method"]
  }
}
```

**AI側の実装ルール例**

- `updateContent` は**全置換** → 実行前に必ず `getContent` をバックアップ。
    
- 修正試行：`run(devMode:true)` → `ok:false` なら `error.stack[0]` の行を見て差分修正 → 最大2回再試行。
    
- 安定後、`createVersion` → 既存を `updateDeployment` で差し替え。
    
- AdminShim が無ければ自動注入（`getContent` → 追記 → `updateContent`）。
    

---

# 6) 認証・運用の勘所

- **A案**（ユーザー権限）で CLI 直叩きが必要なら、**ブラウザ実行 or セッション共有クライアント**を使う。  
    例）Electron / headless browser でクッキー持ち `fetch`、もしくは自前サーバーでブラウザから中継。
    
- **B案**（代行運用）は、`doPost` に**Allowlist**と**共有シークレット**（例：`X-Admin-Token`）を実装して防御。  
    `Session.getActiveUser().getEmail()` は個人アカでは空のことが多いので **頼りすぎない** こと。
    
- **レート制限**：429/5xx は指数バックオフ（最大3回）でリトライ。
    
- **自己更新の落とし穴**：管理プロキシ自身を `updateContent` で壊すと復旧が面倒→**別プロジェクト**に分離が安全。
    

---

# 7) トラブル時のチェックリスト

- `HTTP 401/403`：  
    Web アプリの「実行者／アクセス権」設定、アカウントログイン、Apps Script API 有効化を再確認。
    
- `Missing required param`：  
    `scriptId` や `files` が欠落。ルーターの `required_` エラーを参照。
    
- `updateContent` でファイルが消える：  
    **全置換**仕様。直前バックアップから復元するか、クライアント側で三方差分を入れて最小更新に。
    
- `run` の例外：  
    `error.stack` の先頭（`func/line`）と `logs` を見て修正 → 再試行。
    

---

ここまでで、**エラー／ログ取得、トリガー、プロパティ、HTMLテンプレ、デプロイ**まで一通り“AIが直接”操作できます。  
必要なら、`ensureAdminShim`（未導入プロジェクトへ自動注入）や**差分マージのユーティリティ**もすぐ追加できます。