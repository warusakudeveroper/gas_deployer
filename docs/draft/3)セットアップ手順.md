
**GAS ç®¡ç†ãƒ—ãƒ­ã‚­ã‚·ï¼ˆWeb ã‚¢ãƒ—ãƒªï¼‰ï¼‹ AdminShimï¼ˆå¯¾è±¡GASå´ï¼‰**ã®æ§‹æˆã§ã€ã‚¼ãƒ­ã‹ã‚‰å‹•ãã¾ã§ã‚’æœ€çŸ­æ‰‹é †ã§ã¾ã¨ã‚ã¾ã™ã€‚  
ï¼ˆ_å‰å›å‡ºã—ãŸã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’â€œãã®ã¾ã¾â€ä½¿ãˆã‚‹æ‰‹é †ã§ã™ã€‚å¿…è¦ãªå·®åˆ†ã‚‚ã“ã“ã«å«ã‚ã¾ã—ãŸ_ï¼‰

---

# 0) äº‹å‰ãƒã‚§ãƒƒã‚¯ï¼ˆ1å›ã ã‘ï¼‰

1. **Apps Script API ã‚’æœ‰åŠ¹åŒ–**  
    [https://script.google.com/home/usersettings](https://script.google.com/home/usersettings) â†’ **ã€ŒGoogle Apps Script APIã€ON**ã€‚
    
2. **Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³**ï¼ˆWeb ã‚¢ãƒ—ãƒªã¯åŸºæœ¬ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§èªè¨¼ã•ã‚Œã¾ã™ï¼‰
    
3. é‹ç”¨ãƒ¢ãƒ¼ãƒ‰ã‚’æ±ºã‚ã‚‹
    
    - **A: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã§æ“ä½œï¼ˆæ¨å¥¨ï¼‰**  
        _ã€Œå®Ÿè¡Œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šGoogle ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒã¤å…¨å“¡ã€_  
        â†’ ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã§ã®ã¿å¯¾è±¡GASã‚’æ“ä½œã€‚  
        â€» CLI ã‹ã‚‰ç›´æ¥å©ãå ´åˆã¯èªè¨¼ã‚¯ãƒƒã‚­ãƒ¼ãŒå¿…è¦ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ or ãƒ­ãƒ¼ã‚«ãƒ«HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚»ãƒƒã‚·ãƒ§ãƒ³å…±æœ‰ï¼‰ã€‚
        
    - **B: ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã§æ“ä½œï¼ˆä»£è¡Œé‹ç”¨ï¼‰**  
        _ã€Œå®Ÿè¡Œè€…ï¼šè‡ªåˆ†ã€ã€Œã‚¢ã‚¯ã‚»ã‚¹ï¼šå…¨å“¡ï¼ˆãƒªãƒ³ã‚¯ï¼‰ç­‰ã€_ï¼‹**scriptId Allowlist**ã‚„APIã‚­ãƒ¼ã§ã‚¬ãƒ¼ãƒ‰ã€‚  
        â†’ 1äººï¼ˆã‚ãªãŸï¼‰ã«æ¨©é™ã‚’é›†ä¸­ã€‚CLI ã‹ã‚‰å©ãã‚„ã™ã„ãŒã€æ¨©é™ç®¡ç†ã¯ã‚ãªãŸå´ã§æ‹…ä¿ã€‚
        

---

# 1) ç®¡ç†ãƒ—ãƒ­ã‚­ã‚·ï¼ˆGAS Web ã‚¢ãƒ—ãƒªï¼‰ã‚’ä½œã‚‹

1. Apps Script ã§**æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**ã‚’ä½œæˆï¼ˆä»»æ„åï¼š`GAS Admin Proxy`ï¼‰ã€‚
    
2. `appsscript.json` ã‚’ä»¥ä¸‹ã§ä¸Šæ›¸ãï¼ˆ**ã‚¹ã‚³ãƒ¼ãƒ—é‡è¦**ï¼‰ï¼š
    

```json
{
  "timeZone": "Asia/Tokyo",
  "exceptionLogging": "STACKDRIVER",
  "oauthScopes": [
    "https://www.googleapis.com/auth/script.projects",
    "https://www.googleapis.com/auth/script.deployments",
    "https://www.googleapis.com/auth/script.scriptapp",
    "https://www.googleapis.com/auth/script.external_request",
    "https://www.googleapis.com/auth/drive.readonly"
  ]
}
```

3. `Code.gs` ã«**ç®¡ç†ãƒ—ãƒ­ã‚­ã‚·æœ¬ä½“**ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆå‰å›ã®ã€Œæœ€å°å®Ÿè£…ï¼ˆGASï¼šCode.gsï¼‰ã€ï¼‹`run`/`normalizeRunResult_`ï¼‹ãƒ«ãƒ¼ã‚¿ãƒ¼è¿½è¨˜ã‚’**ä¸¸ã”ã¨**ã‚³ãƒ”ãƒšï¼‰ã€‚
    
    - å«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ï¼š`getContent / updateContent / createVersion / createDeployment / listDeployments / updateDeployment / undeploy / run` ã¨æ­£è¦åŒ–ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€`doPost/doGet`ã€‚
        
4. **ãƒ‡ãƒ—ãƒ­ã‚¤** â†’ **ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒª**
    
    - _Aæ¡ˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™é‹ç”¨ãƒ»æ¨å¥¨ï¼‰_:
        
        - å®Ÿè¡Œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š**ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼**
            
        - ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š**Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒã¤å…¨å“¡**ï¼ˆåŒ¿åä¸å¯ï¼‰
            
    - _Bæ¡ˆï¼ˆç®¡ç†è€…ä»£è¡Œé‹ç”¨ï¼‰_:
        
        - å®Ÿè¡Œè€…ï¼š**è‡ªåˆ†**
            
        - ã‚¢ã‚¯ã‚»ã‚¹ï¼š**å…¨å“¡ï¼ˆãƒªãƒ³ã‚¯ï¼‰** ãªã©
            
        - ä½µã›ã¦ `scriptId` ã® **Allowlist** ã‚„ **å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ**ï¼ˆä¾‹ï¼š`X-Admin-Token`ï¼‰ãƒã‚§ãƒƒã‚¯ã‚’ `doPost` ã«å…¥ã‚Œã‚‹ã¨å®‰å…¨ã€‚
            
5. åˆå›ã‚¢ã‚¯ã‚»ã‚¹ã§**æ¨©é™æ‰¿èª**ï¼ˆè¡¨ç¤ºã•ã‚Œã‚‹æ¨©é™ã‚’ã™ã¹ã¦è¨±å¯ï¼‰ã€‚
    

> âœ… ã“ã‚Œã§ Web ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆ`â€¦/exec`ï¼‰ãŒå‡ºã¾ã—ãŸã€‚ä»¥é™ã€ã“ã®URLã« JSON ã‚’ POST ã™ã‚Œã°ç®¡ç†æ“ä½œãŒã§ãã¾ã™ã€‚

---

# 2) å¯¾è±¡GASã« AdminShim ã‚’å…¥ã‚Œã‚‹ï¼ˆ1å›ã ã‘ï¼‰

ãƒˆãƒªã‚¬ãƒ¼ï¼ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ“ä½œã¯ REST ç›´å©ããŒç„¡ã„ã®ã§**å¯¾è±¡GASå´ã«ã‚·ãƒ **ã‚’ç½®ãã€`scripts.run` ã§å‘¼ã³ã¾ã™ã€‚

1. ç®¡ç†ã—ãŸã„**å¯¾è±¡GAS**ã‚’é–‹ãï¼ˆæ—¢å­˜ã§ã‚‚æ–°è¦ã§ã‚‚OKï¼‰ã€‚
    
2. æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« `AdminShim.gs` ã‚’ä½œæˆã—ã€å‰å›æç¤ºã® **AdminShim ã‚³ãƒ¼ãƒ‰**ã‚’è²¼ã‚Šä»˜ã‘ã€‚
    
    - æä¾›é–¢æ•°ï¼š`admin_listTriggers / admin_createTimeTrigger / admin_deleteTriggerByFunction / admin_listProperties / admin_setProperties / admin_deleteProperty`ã€‚
        
3. åˆå›å®Ÿè¡Œæ™‚ã«**æ¨©é™æ‰¿èª**ãŒå¿…è¦ãªå ´åˆã¯è¨±å¯ã€‚
    

> ğŸ§© AdminShim ãŒå…¥ã£ã¦ã„ãªã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ç®¡ç†ãƒ—ãƒ­ã‚­ã‚·ã® `updateContent` ã§å¾Œã‹ã‚‰**è‡ªå‹•æ³¨å…¥**ã—ã¦ã‚‚OKï¼ˆAIã«ã‚„ã‚‰ã›ã‚‹é‹ç”¨ï¼‰ã€‚

---

# 3) å‹•ä½œãƒ†ã‚¹ãƒˆï¼ˆæœ€ä½é™ã®é€šã—ï¼‰

ä»¥é™ã€ã™ã¹ã¦ **ç®¡ç†ãƒ—ãƒ­ã‚­ã‚·URLï¼ˆ`â€¦/exec`ï¼‰** ã« `Content-Type: application/json` ã§ POSTã€‚

### a. pingï¼ˆç–é€šï¼‰

```json
{ "method": "ping", "params": {} }
```

â†’ `{"ok":true,"data":{"pong":true,"user":null}}` ãªã©ãŒè¿”ã‚Œã°ç–é€šOKã€‚

### b. å¯¾è±¡GASã®ã‚½ãƒ¼ã‚¹å–å¾—

```json
{
  "method": "getContent",
  "params": { "scriptId": "YOUR_SCRIPT_ID" }
}
```

### c. HTMLãƒ†ãƒ³ãƒ—ãƒ¬ã‚’å«ã‚ã¦æ›´æ–°ï¼ˆå…¨ç½®æ›ï¼‰

```json
{
  "method": "updateContent",
  "params": {
    "scriptId": "YOUR_SCRIPT_ID",
    "files": [
      {"name":"Index","type":"HTML","source":"<!doctype html><html><body><?= name ?></body></html>"},
      {"name":"Code","type":"SERVER_JS","source":"function doGet(){ const t=HtmlService.createTemplateFromFile('Index'); t.name='Lacis'; return t.evaluate().setTitle('Demo'); }"},
      {"name":"appsscript","type":"JSON","source":"{ \"timeZone\":\"Asia/Tokyo\" }"}
    ]
  }
}
```

### d. é–¢æ•°å®Ÿè¡Œï¼ˆãƒ­ã‚°ãƒ»ã‚¹ã‚¿ãƒƒã‚¯å–å¾—ï¼‰

```json
{
  "method": "run",
  "params": {
    "scriptId": "YOUR_SCRIPT_ID",
    "functionName": "doGet",
    "parameters": [],
    "devMode": true
  }
}
```

â†’ `ok` / `logs` / `error.stack` / `meta.executionId` ãŒè¿”ã‚Šã¾ã™ã€‚

### e. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä½œæˆ â†’ ãƒ‡ãƒ—ãƒ­ã‚¤

1. `createVersion` â†’ `versionNumber` ã‚’æ§ãˆã‚‹
    
2. `createDeployment`ï¼ˆã¾ãŸã¯ `listDeployments`â†’`updateDeployment` ã§å·®ã—æ›¿ãˆï¼‰
    

---

# 4) ãƒˆãƒªã‚¬ãƒ¼ï¼†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆAdminShim çµŒç”±ï¼‰

### ãƒˆãƒªã‚¬ãƒ¼ä¸€è¦§

```json
{"method":"listTriggers","params":{"scriptId":"YOUR_SCRIPT_ID"}}
```

### 5åˆ†ãŠããƒˆãƒªã‚¬ãƒ¼ä½œæˆ

```json
{
  "method":"createTimeTrigger",
  "params":{"scriptId":"YOUR_SCRIPT_ID","handlerFunction":"tick","everyMinutes":5}
}
```

### ãƒãƒ³ãƒ‰ãƒ©ãƒ¼åã§ä¸€æ‹¬å‰Šé™¤

```json
{
  "method":"deleteTriggerByFunction",
  "params":{"scriptId":"YOUR_SCRIPT_ID","handlerFunction":"tick"}
}
```

### ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£

- ä¸€è¦§
    

```json
{"method":"listProperties","params":{"scriptId":"YOUR_SCRIPT_ID","store":"script"}}
```

- ä¸€æ‹¬è¨­å®š
    

```json
{"method":"setProperties","params":{"scriptId":"YOUR_SCRIPT_ID","store":"script","props":{"API_KEY":"xxx","ENV":"prod"}}}
```

- 1ä»¶å‰Šé™¤
    

```json
{"method":"deleteProperty","params":{"scriptId":"YOUR_SCRIPT_ID","store":"script","key":"API_KEY"}}
```

---

# 5) ClaudeCode / MCP ãƒ„ãƒ¼ãƒ«ç™»éŒ²ï¼ˆæœ€ä½ã‚¹ã‚­ãƒ¼ãƒï¼‰

```json
{
  "name": "gas_admin",
  "description": "Manage GAS: get/update content, run with logs, versions/deployments, triggers & properties.",
  "endpoint": "POST https://script.google.com/macros/s/AKfy.../exec",
  "schema": {
    "type": "object",
    "properties": {
      "method": {
        "type":"string",
        "enum":["ping","getContent","updateContent","createVersion","createDeployment","listDeployments","updateDeployment","undeploy","run","listTriggers","createTimeTrigger","deleteTriggerByFunction","listProperties","setProperties","deleteProperty"]
      },
      "params":{"type":"object"}
    },
    "required":["method"]
  }
}
```

**AIå´ã®å®Ÿè£…ãƒ«ãƒ¼ãƒ«ä¾‹**

- `updateContent` ã¯**å…¨ç½®æ›** â†’ å®Ÿè¡Œå‰ã«å¿…ãš `getContent` ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€‚
    
- ä¿®æ­£è©¦è¡Œï¼š`run(devMode:true)` â†’ `ok:false` ãªã‚‰ `error.stack[0]` ã®è¡Œã‚’è¦‹ã¦å·®åˆ†ä¿®æ­£ â†’ æœ€å¤§2å›å†è©¦è¡Œã€‚
    
- å®‰å®šå¾Œã€`createVersion` â†’ æ—¢å­˜ã‚’ `updateDeployment` ã§å·®ã—æ›¿ãˆã€‚
    
- AdminShim ãŒç„¡ã‘ã‚Œã°è‡ªå‹•æ³¨å…¥ï¼ˆ`getContent` â†’ è¿½è¨˜ â†’ `updateContent`ï¼‰ã€‚
    

---

# 6) èªè¨¼ãƒ»é‹ç”¨ã®å‹˜æ‰€

- **Aæ¡ˆ**ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ï¼‰ã§ CLI ç›´å©ããŒå¿…è¦ãªã‚‰ã€**ãƒ–ãƒ©ã‚¦ã‚¶å®Ÿè¡Œ or ã‚»ãƒƒã‚·ãƒ§ãƒ³å…±æœ‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**ã‚’ä½¿ã†ã€‚  
    ä¾‹ï¼‰Electron / headless browser ã§ã‚¯ãƒƒã‚­ãƒ¼æŒã¡ `fetch`ã€ã‚‚ã—ãã¯è‡ªå‰ã‚µãƒ¼ãƒãƒ¼ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ä¸­ç¶™ã€‚
    
- **Bæ¡ˆ**ï¼ˆä»£è¡Œé‹ç”¨ï¼‰ã¯ã€`doPost` ã«**Allowlist**ã¨**å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ**ï¼ˆä¾‹ï¼š`X-Admin-Token`ï¼‰ã‚’å®Ÿè£…ã—ã¦é˜²å¾¡ã€‚  
    `Session.getActiveUser().getEmail()` ã¯å€‹äººã‚¢ã‚«ã§ã¯ç©ºã®ã“ã¨ãŒå¤šã„ã®ã§ **é ¼ã‚Šã™ããªã„** ã“ã¨ã€‚
    
- **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**ï¼š429/5xx ã¯æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆæœ€å¤§3å›ï¼‰ã§ãƒªãƒˆãƒ©ã‚¤ã€‚
    
- **è‡ªå·±æ›´æ–°ã®è½ã¨ã—ç©´**ï¼šç®¡ç†ãƒ—ãƒ­ã‚­ã‚·è‡ªèº«ã‚’ `updateContent` ã§å£Šã™ã¨å¾©æ—§ãŒé¢å€’â†’**åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**ã«åˆ†é›¢ãŒå®‰å…¨ã€‚
    

---

# 7) ãƒˆãƒ©ãƒ–ãƒ«æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- `HTTP 401/403`ï¼š  
    Web ã‚¢ãƒ—ãƒªã®ã€Œå®Ÿè¡Œè€…ï¼ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã€è¨­å®šã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ã‚°ã‚¤ãƒ³ã€Apps Script API æœ‰åŠ¹åŒ–ã‚’å†ç¢ºèªã€‚
    
- `Missing required param`ï¼š  
    `scriptId` ã‚„ `files` ãŒæ¬ è½ã€‚ãƒ«ãƒ¼ã‚¿ãƒ¼ã® `required_` ã‚¨ãƒ©ãƒ¼ã‚’å‚ç…§ã€‚
    
- `updateContent` ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¶ˆãˆã‚‹ï¼š  
    **å…¨ç½®æ›**ä»•æ§˜ã€‚ç›´å‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã™ã‚‹ã‹ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ä¸‰æ–¹å·®åˆ†ã‚’å…¥ã‚Œã¦æœ€å°æ›´æ–°ã«ã€‚
    
- `run` ã®ä¾‹å¤–ï¼š  
    `error.stack` ã®å…ˆé ­ï¼ˆ`func/line`ï¼‰ã¨ `logs` ã‚’è¦‹ã¦ä¿®æ­£ â†’ å†è©¦è¡Œã€‚
    

---

ã“ã“ã¾ã§ã§ã€**ã‚¨ãƒ©ãƒ¼ï¼ãƒ­ã‚°å–å¾—ã€ãƒˆãƒªã‚¬ãƒ¼ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€HTMLãƒ†ãƒ³ãƒ—ãƒ¬ã€ãƒ‡ãƒ—ãƒ­ã‚¤**ã¾ã§ä¸€é€šã‚Šâ€œAIãŒç›´æ¥â€æ“ä½œã§ãã¾ã™ã€‚  
å¿…è¦ãªã‚‰ã€`ensureAdminShim`ï¼ˆæœªå°å…¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸è‡ªå‹•æ³¨å…¥ï¼‰ã‚„**å·®åˆ†ãƒãƒ¼ã‚¸ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£**ã‚‚ã™ãè¿½åŠ ã§ãã¾ã™ã€‚